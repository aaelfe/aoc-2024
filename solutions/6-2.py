import sys
from pathlib import Path

project_root = str(Path(__file__).parent.parent)
sys.path.append(project_root)

from utils.base import script_handler

input = """......#.............#.....................#..#.........................................................#.................#.#......
.................................#.....#............#........................................#.................................#..
..................#.#.....#........#.#...#.....#..............#................#..#....................................#..#.......
.#....#......................#..........................................................................#......#..................
..............#..................#..#............................................#.....#....#.........#...........................
..............#.......#...#.....#....................................................................#...................#........
....................................................#............#....................................#.............#........#....
..........................#....#...................##.............#.#............................................#................
...............#.......#..................................................#....#..............#..##.....##.................#......
....#............#.......##................#......#.........#.#.......#...#......................#...##...........................
#.........................................#.......#.....#......................#.........#......#.................................
.......#.......#........#......#.......................#..........#....#.##.........#......#.....................#.#..............
..........#.....................#.................#................................................................#..............
...........................................#.................................#............#....................................#..
.....................#.....#..........#...................................................###........#............................
.....#.............#....#.................................#.#............##..#......................................#.............
........#....#.................#..................#............................#...#.#.............#..............................
.............................................#.....#.................................#............................................
......................#.#...................#...#...........................#....#..#............#................................
.......#...#.............#................#................#...............................................#...........#..........
............#............................#..............................................#......................#................#.
......#..............................................#......#.................................#..................................#
................#...............................#.....................................................................#......#....
#....#.............##..................................#.......#..............................#....#..............................
...........#..................#.....#...................................#.........#.........................................#.....
.....#........................#.#.............#.#.......................#........#.....................................#........#.
...................................................................................................#..............................
......#...........................#...................................................#....................................##...#.
#..#...............#.....#............................#....................#...................#...............#..................
.......#.........#......##...........................................#.......................#....................................
.................................................................................#....................#.........#.................
................................#............................................#..............#................................#....
.............................#.............#.............#....#............#.#......#............#...........................#....
....................................#....#...........##..........................................................#................
.......#.....................................................................................#...............................#....
.#....#...............#....................#............................#...............#....................#.................#..
......................................#.#....#....#.......................................................#...................#...
....................#.....#..............................#....................#...........................................#.......
...............................................................................................#.........#........................
.........#............#...........................................................................................................
....#..#.....#..................#..........#.........#............##..#...........................................................
....#.................................#.........................................................#...#..........#..................
...................##.....#.....#.#...#..............................#.........#......#......#............#.......................
.................#.....#....#..................................................................................#..............#...
.....#............#........................................................#.........#..............#.......#.....................
...........#...........................................................#...#..............................#.............#........#
............#....#...............#.....#...................................................................#......................
....#........................#..........#.............................#.....#................................#....................
#............#................#....#..............................................................................................
.......##..........#................................................................#.........#..............................##...
..........#.....................................#.................#.........#................................................#.#..
........#....................#...............#.#.................#..#.................#...............#..#.......................#
................................#.............................##.........#.......#...........#....................................
.....#........#....#...............#............##.......................................................#........................
...#..............................#........................................................................................#......
.....#............................................#............#.....#.........#.........................................#........
........................................#......................................#.#.......#.................................#.#....
..#......#..........................#........................................................................#........#.......#...
.#.....#.#..#........#.......#....................................................................................................
...............................................................#........#...#.....................................................
..................#..........#..............................................#..........................#..........................
..............................................................#................#......#....................#......................
..........##.............#...............................................#...#......#......#.............#........................
.#......#........#.......................#...................................................................................#....
.........................#...........................................................................................#.......#....
.......................................#.................................#......................#........................#..#.#..#
.............#................................................#................#.....................#...................#......#.
...#.....................#.................#.........................................#...#..............................#.........
..#....................................#..............#...........#..........................................#....................
......#...........................................................................................................................
........##............................................#.......................................#.#...#..............##.............
.........#...#.........#.........#...........#....................................................................................
.#..#..........................................#.........^..................................#......................#.........#....
..........................#..................................................#..............#..#......#....#.....#..........#....#
.....................................#.......................................................................................#....
.....#.......#...................#.......#...............................#..#...#...........................................#.....
.........#.#........................................................#......#.....#................................................
..#............#.....#.......#..........................#................................#..........#.............#...............
...............................#....#..#...#..#...............#.......................#..........................................#
.........................................#..............#.............#..........................................#................
..........................#..#.........#........................................................................#.................
.......#.....................................#........................#..#.....#..........#...#.........#.........................
............................................................................................#...............................#.....
....................................................................................#.............................................
........#.................#...................................................................#.......#...........................
..#....#......#............#................#.......#...........#......................#..................................##......
...............#................................#.........#.............................#.........................#...............
...................#...#.......................................................#..#....#......................................#...
..........................##.........#..............................#.....##............#.........................................
..............................................................................#...#.............................##.#..............
#..................#..............................#...............................................................................
.....#..........#.........................................................#.......#...........................##.........#........
..##..#..#..........................#...#...#..............................................................#.#....................
..#.#.........................#...........#...............................................#...#...........#.......................
...............................#......................#......................#.#...............................#..................
.......#.........................#....#..................................................#............#.#.........................
.................#.........#.....#.............................................................................#..................
............#.....................................................#.#................#......#.....#..................#............
.#...............#..............................................................................................#................#
.#....#.................................#..#....#......#...........#..........................................#...................
#.#.................................................................................................................#.............
........#..................#..................................................#................#.#...............#......#.........
........#...................#......................#.......#.#...............#....................................................
.................#.#.........#....#....................#...#........#...#...#.....................................................
.........................#...............................#............................#.............#.................#...........
....#...................................#.#.....................#.............#.........##......#........................#........
..................#..#...#........#...#....#........#.............#............#.....#..............#.......................#.....
....#....#......#..#.....................................#...#......#.........................................................#..#
.....................#................#.#..##..............#...................................#...................#.#............
...........................##.#...............##...........#.......................................................#............#.
................#...................................................................#....#.........#........#..........#..........
...#........#...........................#.............#.................##......#.................................................
............#............................................#..............#...#...........................#.........................
.....#...........................#...............#............#...........#.....................................#....#............
...#................#.......#.......................#.......................................................#...............#.....
..........................................#.....#..#........#..........................................#........................#.
........#..................#.........#.....................#....#.......#..................#.............................#......#.
.........#.#........................................................................#................................#.......#....
..........................#.#..........#.........#.........#.......................#.......................................#......
.........#............................#.............#...#.....#......................#......................................#...#.
...#............................#...................#......................................................................#......
............................#..........#..#..#....#................#..........#...............#.........#.....#...................
##...#.........................#...........#.................#..............................#.....................................
....#.................#.......#............#........#.............................................................#.......#......#
............................##.#................#................#.#.............................................................#
.....#.#........................#.............#.................#......#..........#.........................#....................#
..........................................#.........................#.........................#.......#..#..........#.............
....#.#......#...........................#................#...#.........##...............#..................#.....................
...............................................#...#.#...#...#..........#...#........................#......#.....................
....#.......#....................#........#........#......#.................##...................#.....#...#.............#........"""

@script_handler
def main() -> None:
    # Parse input map into 2D grid
    grid = [list(line) for line in input.strip().splitlines()]
    
    # Find starting position and direction of guard (^)
    start_pos = None
    for y in range(len(grid)):
        for x in range(len(grid[0])):
            if grid[y][x] == '^':
                start_pos = (x, y)
                break
        if start_pos:
            break
    
    # Direction vectors for up, right, down, left
    directions = [(0, -1), (1, 0), (0, 1), (-1, 0)]
    loop_positions = set()

    # Try placing an obstacle at each empty position
    total_positions = sum(1 for y in range(len(grid)) for x in range(len(grid[0])) 
                         if grid[y][x] == '.' and (x, y) != start_pos)
    positions_checked = 0
    
    for y in range(len(grid)):
        for x in range(len(grid[0])):
            # Skip positions that are already occupied or the guard's start
            if grid[y][x] != '.' or (x, y) == start_pos:
                continue
                
            positions_checked += 1
            if positions_checked % 100 == 0:
                print(f"Checking position {positions_checked}/{total_positions} ({(positions_checked/total_positions)*100:.1f}%)")
                
            # Create a copy of the grid with new obstacle
            test_grid = [row[:] for row in grid]
            test_grid[y][x] = '#'
            
            # Simulate guard movement
            curr_pos = start_pos
            curr_dir = 0  # Start facing up
            visited_states = set()
            
            # Add step limit to prevent infinite loops
            step_limit = 10000  # Adjust this value if needed
            steps = 0
            
            while steps < step_limit:
                # Create a unique state representation including position and direction
                current_state = (curr_pos, curr_dir)
                
                # Check for loop: if current state was seen before
                if current_state in visited_states:
                    loop_positions.add((x, y))
                    break
                
                visited_states.add(current_state)
                
                # Get position in front of guard
                next_x = curr_pos[0] + directions[curr_dir][0]
                next_y = curr_pos[1] + directions[curr_dir][1]
                
                # Check if guard has left the mapped area
                if (next_y < 0 or next_y >= len(test_grid) or
                    next_x < 0 or next_x >= len(test_grid[0])):
                    break
                
                # Check if position is blocked by obstacle
                if test_grid[next_y][next_x] == '#':
                    # Turn right 90 degrees
                    curr_dir = (curr_dir + 1) % 4
                else:
                    # Move forward
                    curr_pos = (next_x, next_y)
                
                steps += 1

    print(f"Found {len(loop_positions)} positions that create loops")
if __name__ == "__main__":
    main()